<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ Automation Vision</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
    <style>
        /* CSS stays the same as it is purely presentation */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1a1f3a 0%, #2d1b4e 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.2);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #00d9ff 0%, #7b2cbf 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #a0a0b0;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .graph-panel {
            background: rgba(20, 25, 40, 0.8);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 700px;
        }

        .info-panel {
            background: rgba(20, 25, 40, 0.8);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
            max-height: 700px;
        }

        #network {
            width: 100%;
            height: 650px;
            border-radius: 15px;
            background: rgba(10, 14, 26, 0.9);
            border: 2px solid rgba(0, 217, 255, 0.2);
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #00d9ff 0%, #0099cc 100%);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 217, 255, 0.4);
        }

        .control-btn.secondary {
            background: linear-gradient(135deg, #7b2cbf 0%, #5a1f8c 100%);
        }

        .control-btn.test {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
        }

        .control-btn.execute {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
        }

        .control-btn.install {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            font-weight: 700;
        }

        .control-btn.install.disabled {
            background: linear-gradient(135deg, #666 0%, #444 100%);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .control-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .analysis-section {
            margin-bottom: 25px;
        }

        .analysis-section h3 {
            color: #00d9ff;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-section p {
            color: #a0a0b0;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .analysis-list {
            list-style: none;
            padding: 0;
        }

        .analysis-list li {
            padding: 10px;
            background: rgba(0, 217, 255, 0.1);
            border-left: 3px solid #00d9ff;
            margin-bottom: 8px;
            border-radius: 5px;
            color: #e0e0e0;
        }

        .analysis-list li::before {
            content: '‚ñ∂ ';
            color: #00d9ff;
            font-weight: bold;
            margin-right: 8px;
        }

        .analysis-list.errors li {
            background: rgba(255, 77, 77, 0.1);
            border-left-color: #ff4d4d;
        }

        .analysis-list.errors li::before {
            content: '‚ùå ';
        }

        .analysis-list.warnings li {
            background: rgba(255, 159, 67, 0.1);
            border-left-color: #ff9f43;
        }

        .analysis-list.warnings li::before {
            content: '‚ö†Ô∏è ';
        }

        .analysis-list.success li {
            background: rgba(81, 207, 102, 0.1);
            border-left-color: #51cf66;
        }

        .analysis-list.success li::before {
            content: '‚úÖ ';
        }

        .node-details {
            background: rgba(0, 217, 255, 0.05);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .node-details h4 {
            color: #00d9ff;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .node-details pre {
            background: rgba(10, 14, 26, 0.9);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85em;
            color: #a0a0b0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 12px 24px;
            background: rgba(255, 50, 50, 0.2);
            border: 1px solid rgba(255, 50, 50, 0.5);
            border-radius: 8px;
            color: #ff6b6b;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            z-index: 1000;
        }

        .back-btn:hover {
            background: rgba(255, 50, 50, 0.3);
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #00d9ff;
            font-size: 1.2em;
        }

        .spinner {
            border: 4px solid rgba(0, 217, 255, 0.1);
            border-top: 4px solid #00d9ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .test-result {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .test-result.success {
            background: rgba(81, 207, 102, 0.1);
            border: 2px solid #51cf66;
            color: #51cf66;
        }

        .test-result.error {
            background: rgba(255, 77, 77, 0.1);
            border: 2px solid #ff4d4d;
            color: #ff4d4d;
        }

        .test-result.warning {
            background: rgba(255, 159, 67, 0.1);
            border: 2px solid #ff9f43;
            color: #ff9f43;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="./" class="back-btn">‚Üê Go Back</a>

    <div class="container">
        <div class="header">
            <h1>üé¨ Automation Vision</h1>
            <p>Visualize and test your automations like never before!</p>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading automation...</p>
        </div>

        <div id="main-content" class="main-content" style="display: none;">
            <div class="graph-panel">
                <div class="controls">
                    <button class="control-btn" onclick="fitNetwork()">üìê Fit View</button>
                    <button class="control-btn secondary" onclick="resetPhysics()">üîÑ Reset Physics</button>
                    <button class="control-btn test" onclick="testAutomation()">üß™ Test Automation</button>
                    <button class="control-btn execute" onclick="executeAutomation()">‚ñ∂Ô∏è Execute Automation</button>
                    <button class="control-btn install disabled" id="installBtn" onclick="installAutomation()">üíæ Install in HA</button>
                    <button class="control-btn secondary" onclick="debugAutomations()">üîç System Debug</button>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4caf50;"></div>
                        <span>Start/End</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #FF9800;"></div>
                        <span>Trigger</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2196F3;"></div>
                        <span>Condition</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9C27B0;"></div>
                        <span>Action</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00BCD4;"></div>
                        <span>Logic</span>
                    </div>
                </div>

                <div id="network"></div>
            </div>

            <div class="info-panel">
                <div id="test-results"></div>
                <div id="ai-analysis"></div>
                <div id="node-info"></div>
            </div>
        </div>
    </div>

    <script>
        let network = null;
        let physicsEnabled = true;
        let graphData = null;
        let automationYAML = '';
        let testResults = null;

        document.addEventListener('DOMContentLoaded', async () => {
            automationYAML = localStorage.getItem('automation_for_vision');
            if (!automationYAML) {
                alert('No automation found!');
                window.location.href = './';
                return;
            }

            try {
                const response = await fetch('./api/visualize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ automation: automationYAML })
                });

                if (response.status === 401) {
                    window.location.href = './login';
                    return;
                }

                const data = await response.json();
                
                if (data.graph && data.graph.nodes) {
                    graphData = data.graph;
                    renderGraph(graphData);
                    renderAnalysis(data.analysis, graphData.info);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('main-content').style.display = 'grid';
                } else {
                    throw new Error(data.error || 'Automation parsing error');
                }
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    <h2 style="color: #ff4d4d;">Error</h2>
                    <p>${error.message}</p>
                    <p><a href="./" style="color: #00d9ff;">Go Back</a></p>
                `;
            }
        });

        async function debugAutomations() {
            const container = document.getElementById('test-results');
            container.innerHTML = '<div class="test-result"><h2>üîç System analysis in progress...</h2></div>';
            
            try {
                const response = await fetch('./api/debug_automations', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                let html = `
                    <div class="test-result success">
                        <h2>üîç SYSTEM DIAGNOSTICS</h2>
                    </div>
                `;
                
                // Installation Method
                html += `
                    <div class="analysis-section">
                        <h3>‚öôÔ∏è Installation Method</h3>
                        <ul class="analysis-list success">
                            <li>‚úÖ <strong>Home Assistant API</strong> - Primary method</li>
                            <li>‚úÖ Automations are created via REST API calls</li>
                            <li>‚úÖ Home Assistant saves them automatically</li>
                            <li>‚úÖ No direct filesystem access required</li>
                        </ul>
                    </div>
                `;
                
                // Automations in HA
                if (result.ha_automations) {
                    html += `
                        <div class="analysis-section">
                            <h3>ü§ñ Automations in Home Assistant</h3>
                            <ul class="analysis-list success">
                                <li><strong>Total active automations:</strong> ${result.ha_automations.count || 0}</li>
                    `;
                    if (result.ha_automations.list && result.ha_automations.list.length > 0) {
                        html += `<li><strong>Last 10 automations:</strong></li>`;
                        result.ha_automations.list.forEach(name => {
                            html += `<li style="margin-left: 20px;">‚Ä¢ ${name}</li>`;
                        });
                    }
                    html += `</ul></div>`;
                }
                
                // Working Status
                const automationsCount = result.ha_automations ? result.ha_automations.count : 0;
                if (automationsCount > 0) {
                    html += `
                        <div class="analysis-section">
                            <h3>‚úÖ System Status</h3>
                            <ul class="analysis-list success">
                                <li>‚úÖ <strong>${automationsCount} automations</strong> present in Home Assistant</li>
                                <li>‚úÖ API installation working</li>
                                <li>‚úÖ System operating correctly</li>
                                <li>‚úÖ All installed automations are visible in Settings ‚Üí Automations</li>
                            </ul>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="analysis-section">
                            <h3>‚ÑπÔ∏è Information</h3>
                            <ul class="analysis-list">
                                <li>No automations found in Home Assistant</li>
                                <li>The system is ready to create new automations</li>
                            </ul>
                        </div>
                    `;
                }
                
                // Advanced tech info
                html += `
                    <div class="analysis-section">
                        <h3 style="cursor: pointer;" onclick="document.getElementById('tech-details').style.display = document.getElementById('tech-details').style.display === 'none' ? 'block' : 'none'">
                            üîß Advanced Technical Details <span style="font-size: 0.8em;">(click to expand)</span>
                        </h3>
                        <div id="tech-details" style="display: none;">
                            <p style="color: #a0a0b0; margin: 10px 0;">
                                The addon can access the container filesystem but does not need direct access to Home Assistant's filesystem.
                            </p>
                            <ul class="analysis-list" style="color: #666;">
                                <li><strong>Container filesystem paths:</strong></li>
                `;
                
                result.paths_checked.forEach(p => {
                    const icon = p.exists ? '‚úÖ' : '‚ö™';
                    const status = p.exists ? `Present (${p.size} bytes)` : 'Not mounted (normal)';
                    html += `<li style="margin-left: 20px; color: #666;">${icon} ${p.path} - ${status}</li>`;
                });
                
                html += `
                            </ul>
                            <p style="color: #a0a0b0; margin: 10px 0;">
                                <strong>Note:</strong> Empty files in the container is normal and expected. 
                                The addon communicates with Home Assistant via API, not via direct file access.
                            </p>
                        </div>
                    </div>
                `;
                
                // Conclusion
                if (automationsCount > 0) {
                    html += `
                        <div class="analysis-section">
                            <h3>üéâ Conclusion</h3>
                            <p style="color: #51cf66; font-size: 1.1em; font-weight: 600;">
                                ‚úÖ System 100% operational!
                            </p>
                            <p style="color: #a0a0b0;">
                                The addon is working correctly. All created automations are saved 
                                in Home Assistant and are visible in Settings ‚Üí Automations & Scenes.
                            </p>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `
                    <div class="test-result error">
                        ‚ùå DIAGNOSTIC ERROR
                    </div>
                    <div class="analysis-section">
                        <h3>Error</h3>
                        <p style="color: #ff4d4d;">${error.message}</p>
                    </div>
                `;
            }
        }

        async function installAutomation() {
            const installBtn = document.getElementById('installBtn');
            
            if (installBtn.classList.contains('disabled')) {
                if (!testResults || Object.keys(testResults).length === 0) {
                    alert('‚ö†Ô∏è BEFORE INSTALLING:\n\n1. You must TEST the automation (üß™ Test Automation)\n2. The test must be ALL GREEN ‚úÖ\n3. No entity or service errors\n\nInstallation is only allowed with OK validation!');
                } else if (testResults.errors && testResults.errors.length > 0) {
                    const errorList = testResults.errors.join('\n‚Ä¢ ');
                    alert(`‚ö†Ô∏è CANNOT INSTALL!\n\nThere are ERRORS in the automation:\n\n‚Ä¢ ${errorList}\n\nFix errors and test again before installing!`);
                } else {
                    alert('‚ö†Ô∏è Before installing you must:\n\n1. Test the automation (üß™ Test)\n2. Ensure it is ALL GREEN ‚úÖ\n\nInstallation is only allowed with OK validation!');
                }
                return;
            }
            
            if (!confirm('üíæ INSTALL IN HOME ASSISTANT\n\nThis operation will:\n‚úÖ Write the automation to automations.yaml\n‚úÖ Reload automations\n‚úÖ Set the automation as ACTIVE\n\nAre you sure you want to continue?')) {
                return;
            }
            
            installBtn.classList.add('disabled');
            installBtn.textContent = '‚è≥ Installing...';

            try {
                const response = await fetch('./api/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ automation: automationYAML })
                });

                const result = await response.json();

                if (result.success) {
                    displayInstallSuccess(result);
                } else {
                    displayInstallError(result);
                }

            } catch (error) {
                displayInstallError({ error: error.message });
            } finally {
                installBtn.classList.remove('disabled');
                installBtn.textContent = 'üíæ Install in HA';
            }
        }

        function displayInstallSuccess(result) {
            const container = document.getElementById('test-results');
            
            const reloaded = result.reloaded || false;
            const note = result.note || '';
            
            let html = `
                <div class="test-result success">
                    ‚úÖ AUTOMATION ${reloaded ? 'INSTALLED' : 'WRITTEN'} SUCCESSFULLY!
                </div>
                
                <div class="analysis-section">
                    <h3>üíæ Installation Completed</h3>
                    <ul class="analysis-list success">
                        <li>Automation "${result.alias}" written to automations.yaml</li>
                        ${reloaded ? '<li>Automations reloaded automatically</li>' : '<li>File written correctly</li>'}
                        ${result.id ? `<li>ID: ${result.id}</li>` : ''}
                    </ul>
                </div>
            `;
            
            if (!reloaded || note) {
                html += `
                    <div class="analysis-section">
                        <h3>‚ö†Ô∏è Manual Reload Required</h3>
                        <p style="color: #ff9f43; margin-bottom: 15px;">
                            ${note || 'Automatic reload might not have worked.'}
                        </p>
                        <ul class="analysis-list warnings">
                            <li>Go to <strong>Settings ‚Üí Automations & Scenes</strong></li>
                            <li>Click the 3 dots <strong>‚ãÆ</strong> in the top right</li>
                            <li>Click <strong>"Reload automations"</strong></li>
                            <li>Or: <strong>Restart Home Assistant</strong></li>
                            <li>Then press <strong>F5</strong> on the Automations page</li>
                        </ul>
                    </div>
                `;
            }
            
            html += `
                <div class="analysis-section">
                    <h3>üéØ Verify Automation</h3>
                    <ul class="analysis-list">
                        <li>Go to <strong>Settings ‚Üí Automations & Scenes</strong></li>
                        <li>Search for "${result.alias}"</li>
                        <li>If you don't see it immediately, press <strong>F5</strong> to refresh</li>
                        <li>It should be present and ${reloaded ? 'ACTIVE' : 'ready to be enabled'}!</li>
                    </ul>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayInstallError(result) {
            const container = document.getElementById('test-results');
            
            let errorMsg = result.error || 'Unknown error';
            let workaround = result.workaround || '';
            
            let html = `
                <div class="test-result error">
                    ‚ùå AUTOMATIC INSTALLATION FAILED
                </div>
                
                <div class="analysis-section">
                    <h3>‚ùå Error Details</h3>
                    <ul class="analysis-list errors">
                        <li>${errorMsg}</li>
                    </ul>
                </div>
            `;
            
            if (workaround) {
                html += `
                    <div class="analysis-section">
                        <h3>üí° Alternative Solution</h3>
                        <p style="color: #ff9f43; margin-bottom: 15px;">
                            ${workaround}
                        </p>
                        <button class="control-btn" onclick="copyYAMLToClipboard()" style="margin: 10px 0;">
                            üìã Copy YAML to Clipboard
                        </button>
                        <ul class="analysis-list">
                            <li>1. Click "üìã Copy YAML"</li>
                            <li>2. Go to Settings ‚Üí Automations & Scenes</li>
                            <li>3. Click "Add Automation"</li>
                            <li>4. Click "Skip" (bottom button)</li>
                            <li>5. Click "‚ãÆ" ‚Üí "Edit in YAML"</li>
                            <li>6. Paste the copied YAML</li>
                            <li>7. Click "SAVE"</li>
                        </ul>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function copyYAMLToClipboard() {
            navigator.clipboard.writeText(automationYAML).then(() => {
                alert('‚úÖ YAML copied to clipboard!\n\nNow go to Home Assistant:\n1. Settings ‚Üí Automations\n2. Add Automation ‚Üí Skip\n3. ‚ãÆ ‚Üí Edit in YAML\n4. Paste (Ctrl+V)\n5. SAVE');
            }).catch(err => {
                const textarea = document.createElement('textarea');
                textarea.value = automationYAML;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úÖ YAML copied! Paste it into Home Assistant.');
            });
        }

        async function executeAutomation() {
            const executeBtn = document.querySelector('.control-btn.execute');
            
            if (!confirm('‚ö†Ô∏è WARNING!\n\nThis will ACTUALLY TRIGGER the automation actions (turn on lights, send notifications, etc.).\n\nAre you sure you want to proceed?')) {
                return;
            }
            
            executeBtn.classList.add('disabled');
            executeBtn.textContent = '‚è≥ Executing...';

            try {
                const response = await fetch('./api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ automation: automationYAML })
                });

                const result = await response.json();
                displayExecutionResults(result);

            } catch (error) {
                alert('Execution error: ' + error.message);
            } finally {
                executeBtn.classList.remove('disabled');
                executeBtn.textContent = '‚ñ∂Ô∏è Execute Automation';
            }
        }

        function displayExecutionResults(result) {
            const container = document.getElementById('test-results');
            
            let html = '';

            if (result.success) {
                html += `
                    <div class="test-result success">
                        ‚úÖ AUTOMATION EXECUTED SUCCESSFULLY!
                    </div>
                `;
            } else {
                html += `
                    <div class="test-result error">
                        ‚ùå EXECUTION COMPLETED WITH ERRORS
                    </div>
                `;
            }

            if (result.results && result.results.length > 0) {
                html += `<div class="analysis-section">
                    <h3>üìã Execution Results (${result.total_actions} actions)</h3>
                    <ul class="analysis-list ${result.success ? 'success' : 'errors'}">`;
                
                result.results.forEach(r => {
                    if (r.success) {
                        html += `<li style="background: rgba(81, 207, 102, 0.1); border-left-color: #51cf66;">
                            ‚úÖ ${r.action} ‚Üí ${r.entity || 'Executed'}
                        </li>`;
                    } else {
                        html += `<li style="background: rgba(255, 77, 77, 0.1); border-left-color: #ff4d4d;">
                            ‚ùå ${r.action} ‚Üí Error: ${r.error}
                        </li>`;
                    }
                });
                
                html += `</ul></div>`;
            }

            html += `
                <div class="analysis-section">
                    <h3>üí° Note</h3>
                    <p style="color: #a0a0b0;">
                        Actions were REALITY executed in your Home Assistant.
                        Check your devices to verify the outcome.
                    </p>
                </div>
            `;

            container.innerHTML = html;
        }

        async function testAutomation() {
            const testBtn = document.querySelector('.control-btn.test');
            const installBtn = document.getElementById('installBtn');
            
            testBtn.classList.add('disabled');
            testBtn.textContent = '‚è≥ Testing...';

            try {
                const response = await fetch('./api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ automation: automationYAML })
                });

                const result = await response.json();
                testResults = result;

                updateGraphColors(result);
                displayTestResults(result);
                
                if (result.valid && (!result.errors || result.errors.length === 0)) {
                    installBtn.classList.remove('disabled');
                    installBtn.style.cursor = 'pointer';
                } else {
                    installBtn.classList.add('disabled');
                    installBtn.style.cursor = 'not-allowed';
                }

            } catch (error) {
                alert('Test error: ' + error.message);
                installBtn.classList.add('disabled');
            } finally {
                testBtn.classList.remove('disabled');
                testBtn.textContent = 'üß™ Test Automation';
            }
        }

        function updateGraphColors(testResult) {
            if (!network || !graphData) return;

            const nodes = graphData.nodes;
            const updates = [];

            nodes.forEach(node => {
                let color = getOriginalColor(node.type);
                let borderColor = '#ffffff';
                
                const entityId = node.entity_id || '';
                const service = node.service || '';

                if (testResult.entity_errors && entityId && testResult.entity_errors[entityId]) {
                    color = '#ff4d4d';
                    borderColor = '#ff0000';
                } else if (testResult.service_errors && service && testResult.service_errors[service]) {
                    color = '#ff9f43';
                    borderColor = '#ff7f00';
                } else if (testResult.valid && node.type !== 'start' && node.type !== 'end') {
                    borderColor = '#51cf66';
                }

                updates.push({
                    id: node.id,
                    color: {
                        background: color,
                        border: borderColor,
                        highlight: {
                            background: color,
                            border: '#00d9ff'
                        }
                    }
                });
            });

            network.body.data.nodes.update(updates);
        }

        function getOriginalColor(type) {
            switch(type) {
                case 'start':
                case 'end':
                    return '#4caf50';
                case 'trigger':
                    return '#FF9800';
                case 'condition':
                    return '#2196F3';
                case 'action':
                    return '#9C27B0';
                case 'logic':
                    return '#00BCD4';
                default:
                    return '#607D8B';
            }
        }

        function displayTestResults(result) {
            const container = document.getElementById('test-results');
            
            let html = '';

            if (result.valid) {
                html += `
                    <div class="test-result success">
                        ‚úÖ AUTOMATION VALID!
                    </div>
                `;
            } else {
                html += `
                    <div class="test-result error">
                        ‚ùå AUTOMATION CONTAINS ERRORS!
                    </div>
                `;
            }

            if (result.errors && result.errors.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3>‚ùå Critical Errors</h3>
                        <ul class="analysis-list errors">
                            ${result.errors.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                        <div style="background: #ff4d4d; color: white; padding: 15px; border-radius: 8px; margin-top: 15px; font-weight: 600;">
                            ‚ö†Ô∏è INSTALLATION BLOCKED!<br>
                            <span style="font-weight: 400; font-size: 0.9em;">
                            Fix these errors before you can install the automation.
                            The "üíæ Install in HA" button will remain disabled until resolved.
                            </span>
                        </div>
                    </div>
                `;
            }

            if (result.warnings && result.warnings.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3>‚ö†Ô∏è Warnings</h3>
                        <ul class="analysis-list warnings">
                            ${result.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (result.valid && (!result.warnings || result.warnings.length === 0)) {
                html += `
                    <div class="analysis-section">
                        <h3>‚úÖ Everything OK</h3>
                        <ul class="analysis-list success">
                            <li>Syntax valid YAML</li>
                            <li>All entities exist</li>
                            <li>All services available</li>
                            <li>Ready for installation!</li>
                        </ul>
                        <p style="color: #51cf66; margin-top: 15px; font-weight: 600;">
                            üíæ You can now click "Install in HA" to deploy automatically!
                        </p>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderGraph(graphData) {
            const nodes = graphData.nodes.map(node => {
                let color;
                switch(node.type) {
                    case 'start':
                    case 'end':
                        color = '#4caf50';
                        break;
                    case 'trigger':
                        color = '#FF9800';
                        break;
                    case 'condition':
                        color = '#2196F3';
                        break;
                    case 'action':
                        color = '#9C27B0';
                        break;
                    case 'logic':
                        color = '#00BCD4';
                        break;
                    default:
                        color = '#607D8B';
                }

                return {
                    id: node.id,
                    label: node.label,
                    title: node.description,
                    color: {
                        background: color,
                        border: '#ffffff',
                        highlight: {
                            background: color,
                            border: '#00d9ff'
                        }
                    },
                    font: {
                        color: '#ffffff',
                        size: 14,
                        face: 'monospace'
                    },
                    shape: node.type === 'logic' ? 'diamond' : 'box',
                    size: 25,
                    borderWidth: 2,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0, 217, 255, 0.5)',
                        size: 10,
                        x: 0,
                        y: 0
                    }
                };
            });

            const edges = graphData.edges.map(edge => ({
                from: edge.from,
                to: edge.to,
                label: edge.label,
                arrows: 'to',
                color: {
                    color: '#00d9ff',
                    highlight: '#ff00ff',
                    opacity: 0.8
                },
                font: {
                    color: '#a0a0b0',
                    size: 12,
                    align: 'middle'
                },
                width: 2,
                smooth: {
                    type: 'cubicBezier',
                    roundness: 0.5
                },
                shadow: {
                    enabled: true,
                    color: 'rgba(0, 217, 255, 0.3)',
                    size: 5
                }
            }));

            const container = document.getElementById('network');
            const data = {
                nodes: new vis.DataSet(nodes),
                edges: new vis.DataSet(edges)
            };

            const options = {
                layout: {
                    hierarchical: {
                        direction: 'UD',
                        sortMethod: 'directed',
                        nodeSpacing: 150,
                        levelSeparation: 200
                    }
                },
                physics: {
                    enabled: true,
                    hierarchicalRepulsion: {
                        centralGravity: 0.0,
                        springLength: 200,
                        springConstant: 0.01,
                        nodeDistance: 200,
                        damping: 0.09
                    },
                    solver: 'hierarchicalRepulsion',
                    stabilization: {
                        iterations: 100
                    }
                },
                interaction: {
                    hover: true,
                    zoomView: true,
                    dragView: true
                },
                nodes: {
                    borderWidthSelected: 4
                }
            };

            network = new vis.Network(container, data, options);

            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = graphData.nodes.find(n => n.id === nodeId);
                    if (node) {
                        showNodeDetails(node);
                    }
                }
            });

            animateFlow(data.edges);
        }

        function animateFlow(edges) {
            let step = 0;
            const totalEdges = edges.length;

            setInterval(() => {
                edges.forEach((edge, index) => {
                    const highlight = (index === step % totalEdges);
                    edges.update({
                        id: edge.id,
                        color: {
                            color: highlight ? '#ff00ff' : '#00d9ff',
                            opacity: highlight ? 1 : 0.6
                        },
                        width: highlight ? 4 : 2
                    });
                });
                step++;
            }, 1000);
        }

        function renderAnalysis(analysis, info) {
            const container = document.getElementById('ai-analysis');
            
            let html = `
                <div class="analysis-section">
                    <h3>üìã ${info.alias}</h3>
                    ${info.description ? `<p>${info.description}</p>` : ''}
                    <p style="color: #666; font-size: 0.9em;">Mode: ${info.mode}</p>
                </div>
            `;

            if (analysis.summary) {
                html += `
                    <div class="analysis-section">
                        <h3>üß† AI Summary</h3>
                        <p>${analysis.summary}</p>
                    </div>
                `;
            }

            if (analysis.triggers && analysis.triggers.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3>‚è∞ Activation (Triggers)</h3>
                        <ul class="analysis-list">
                            ${analysis.triggers.map(t => `<li>${t}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (analysis.conditions && analysis.conditions.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3>‚úÖ Conditions</h3>
                        <ul class="analysis-list">
                            ${analysis.conditions.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (analysis.actions && analysis.actions.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3>üéØ Actions</h3>
                        <ul class="analysis-list">
                            ${analysis.actions.map(a => `<li>${a}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (analysis.suggestions && analysis.suggestions.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3>üí° AI Suggestions</h3>
                        <ul class="analysis-list">
                            ${analysis.suggestions.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function showNodeDetails(node) {
            const container = document.getElementById('node-info');
            container.innerHTML = `
                <div class="node-details">
                    <h4>${node.icon} ${node.label.split('\n')[0]}</h4>
                    <p style="color: #a0a0b0; margin-bottom: 15px;">Type: ${node.type}</p>
                    <pre>${node.description}</pre>
                </div>
            `;
        }

        function fitNetwork() {
            if (network) {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }
        }

        function resetPhysics() {
            if (network) {
                network.setOptions({
                    physics: {
                        enabled: true
                    }
                });
                setTimeout(() => {
                    network.stopSimulation();
                }, 2000);
            }
        }
    </script>
</body>
</html>
